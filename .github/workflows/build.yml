name: Build Installers

on:
  push:
    branches: [main, update]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            artifact: windows
            type: exe
          - os: macos-latest
            artifact: macos
            type: dmg
          - os: ubuntu-latest
            artifact: linux
            type: deb

    runs-on: ${{ matrix.os }}

    defaults:
      run:
        working-directory: ./ App Foyer

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Build with Maven
        run: mvn clean package -DskipTests

      - name: List target directory (Unix)
        if: matrix.os != 'windows-latest'
        run: ls -la target/

      - name: List target directory (Windows)
        if: matrix.os == 'windows-latest'
        run: dir target

      - name: Create installer (Windows)
        if: matrix.os == 'windows-latest'
        shell: cmd
        run: |
          jpackage --input target --name "Foyer Vietnam" --main-jar FoyerVietnam.jar --main-class Launcher --type exe --dest target/installer --app-version 1.0.0 --vendor "Foyer Vietnam" --description "Application de gestion des commandes" --win-dir-chooser --win-shortcut --win-menu --win-menu-group "Foyer Vietnam" --java-options "--enable-native-access=ALL-UNNAMED"

      - name: Create installer (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          jpackage --input target --name "Foyer Vietnam" --main-jar FoyerVietnam.jar --main-class Launcher --type dmg --dest target/installer --app-version 1.0.0 --vendor "Foyer Vietnam" --description "Application de gestion des commandes" --java-options "--enable-native-access=ALL-UNNAMED"

      - name: Create installer (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          jpackage --input target --name "foyer-vietnam" --main-jar FoyerVietnam.jar --main-class Launcher --type deb --dest target/installer --app-version 1.0.0 --vendor "Foyer Vietnam" --description "Application de gestion des commandes" --linux-shortcut --java-options "--enable-native-access=ALL-UNNAMED"

      - name: List installer directory (Unix)
        if: matrix.os != 'windows-latest'
        run: ls -la target/installer/ || echo "Installer directory not found"

      - name: List installer directory (Windows)
        if: matrix.os == 'windows-latest'
        shell: cmd
        run: dir target\installer || echo "Installer directory not found"

      - name: Upload installer
        uses: actions/upload-artifact@v4
        with:
          name: foyer-vietnam-${{ matrix.artifact }}
          path: ./ App Foyer/target/installer/
          if-no-files-found: error
          retention-days: 30

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: installers

      - name: Display structure
        run: ls -R installers

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v1.0.${{ github.run_number }}
          name: Foyer Vietnam v1.0.${{ github.run_number }}
          body: |
            ## Foyer Vietnam - Installation

            Téléchargez le fichier correspondant à votre système :
            - **Windows** : `Foyer Vietnam-1.0.0.exe`
            - **macOS** : `Foyer Vietnam-1.0.0.dmg`
            - **Linux** : `foyer-vietnam_1.0.0_amd64.deb`

            Aucune installation de Java requise !
          files: |
            installers/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
